<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>檢查人員考核系統｜考生版</title>

<!-- 固定讀取現有根目錄檔案 -->
<script src="people.data.js"></script>
<script src="questions.data.js"></script>

<style>
:root{ --brand:#1d6dc9; --ink:#111827; --muted:#6b7280; --bg:#f7fafc; --card:#fff; --bd:#e5e7eb; --ok:#059669; --warn:#d97706; --err:#e11d48; }
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.container{max-width:980px;margin:auto;padding:20px}
h1{margin:8px 0 12px;font-size:22px;letter-spacing:.5px;color:var(--brand);font-weight:900}
.card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 8px 24px rgba(0,0,0,.04)}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:240px}
select,button{width:100%;padding:12px;border:1px solid var(--bd);border-radius:12px;font-size:15px}
button{background:var(--brand);color:#fff;border:none;cursor:pointer;font-weight:700}
button:disabled{opacity:.5;cursor:not-allowed}
.kv{font-size:14px;color:var(--muted)}
.progress{height:10px;background:#e6eefc;border-radius:999px;overflow:hidden;margin-top:4px}
.progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#1d6dc9,#60a5fa)}
.hr{height:1px;background:var(--bd);margin:14px 0}
.question{border-top:1px dashed var(--bd);padding-top:12px;margin-top:12px}
.qtitle{font-weight:700}
.radio{display:flex;gap:16px;margin-top:8px}
.table{width:100%;border-collapse:collapse;font-size:14px;margin-top:8px}
.table th,.table td{border:1px solid var(--bd);padding:8px;text-align:left}
.table th{background:#f3f8ff;color:#155a9e}
.note{font-size:12px;color:var(--muted)}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .25s}
.toast.show{opacity:1}
.hidden{display:none!important}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--bd);font-size:12px;color:#155a9e;background:#f3f8ff;margin-right:6px}
</style>
</head>
<body>
<div class="container">
  <h1>檢查人員考核系統｜考生版</h1>

  <!-- Start -->
  <div id="startCard" class="card">
    <div class="row">
      <div class="col">
        <label>請選擇姓名</label>
        <select id="selPerson"><option value="">— 請選擇 —</option></select>
        <div class="kv">部門：<b id="kvDept">-</b></div>
        <div class="kv">題目類別：<span id="kvCats"></span></div>
      </div>
      <div class="col">
        <label>出題數量</label>
        <select id="selCount">
          <option value="10" selected>10 題</option>
          <option value="12">12 題</option>
          <option value="15">15 題</option>
          <option value="20">20 題</option>
        </select>
        <div class="kv">最小及格率：<b>90%</b></div>
      </div>
    </div>
    <div class="hr"></div>
    <button id="btnStart" disabled>開始作答</button>
  </div>

  <!-- Exam -->
  <div id="examCard" class="card hidden" aria-live="polite">
    <div class="row">
      <div class="col"><div class="kv">考生：<b id="kvName">-</b></div></div>
      <div class="col"><div class="kv">出題數：<b id="kvCount">-</b></div></div>
      <div class="col">
        <div class="kv">作答進度</div>
        <div class="progress"><i id="progBar"></i></div>
      </div>
    </div>
    <div id="qList"></div>
    <div class="hr"></div>
    <button id="btnSubmit" disabled>送出答案</button>
  </div>

  <!-- Result -->
  <div id="resultCard" class="card hidden" aria-live="polite">
    <div class="row">
      <div class="col"><div class="kv">總分：<b id="scScore">-</b></div></div>
      <div class="col"><div class="kv">正確率：<b id="scRate">-</b></div></div>
      <div class="col"><div class="kv">判定：<b id="scPass">-</b></div></div>
    </div>
    <div id="wrongBox" style="margin-top:12px;"></div>
    <p class="note">系統已自動上傳成績至 Google 試算表，無需另外回報。</p>
  </div>
</div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ===== 設定 ===== */
const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwXmceMbgiut0dCnVECBqRsePx80cdH2AQiM1DMr6YK8w2yS5faXzkaSIGaw3A23x-v-w/exec';
const PASS_THRESHOLD = 90;

/* ===== 工具 ===== */
const $ = s=>document.querySelector(s);
const toast = (m)=>{const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);};
const shuffle = a=>a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]);

/* ===== 名單 ===== */
const selPerson=$('#selPerson'), kvDept=$('#kvDept'), kvCats=$('#kvCats'), btnStart=$('#btnStart'), selCount=$('#selCount');
const enabledPeople=(window.PEOPLE_DATA||[]).filter(p=>String(p.enabled)==='1'||p.enabled===1);
enabledPeople.sort((a,b)=>(a.dept||'').localeCompare(b.dept||'')||(a.name||'').localeCompare(b.name||''))
  .forEach(p=>{const o=document.createElement('option');o.value=p.name;o.textContent=`${p.dept}｜${p.name}`;selPerson.appendChild(o);});
let currentPerson=null;
selPerson.addEventListener('change',()=>{
  currentPerson=enabledPeople.find(p=>p.name===selPerson.value)||null;
  if(!currentPerson){kvDept.textContent='-';kvCats.innerHTML='';btnStart.disabled=true;return;}
  kvDept.textContent=currentPerson.dept||'-';
  const cats=['A','B','C','D','E','F'].filter(k=>String(currentPerson[k]||'')==='Y');
  kvCats.innerHTML=cats.length?cats.map(c=>`<span class="badge">類別 ${c}</span>`).join(''):'<span class="badge">未設定</span>';
  btnStart.disabled = cats.length===0;
});

/* ===== 題庫整理 ===== */
const QUESTIONS=(window.QUESTIONS_DATA||[]).slice();
const byCat={}; QUESTIONS.forEach(q=>{const c=String(q['分類']||q['類別']||'').trim();(byCat[c]??=[]).push(q);});
Object.keys(byCat).forEach(c=>byCat[c]=shuffle(byCat[c]));

/* ===== 出題/作答 ===== */
const kvName=$('#kvName'), kvCount=$('#kvCount'), qList=$('#qList'), progBar=$('#progBar'), btnSubmit=$('#btnSubmit');
const examCard=$('#examCard'), startCard=$('#startCard'), resultCard=$('#resultCard');

let paper=[], answers={};
function buildPaper(cats,count){
  const buckets=cats.map(c=>(byCat[c]||[]).slice());
  const out=[]; let i=0;
  while(out.length<count && buckets.some(b=>b.length)){ const b=buckets[i%buckets.length]; if(b.length) out.push(b.shift()); i++; }
  if(out.length<count){ const rest=shuffle(QUESTIONS.filter(q=>cats.includes(String(q['分類']||q['類別']||'').trim()))); for(const q of rest){ if(out.length>=count)break; if(!out.includes(q)) out.push(q);} }
  return out.map((q,i)=>({...q,_no:i+1}));
}
function renderExam(){ qList.innerHTML=''; answers={};
  paper.forEach((q,idx)=>{ const w=document.createElement('div'); w.className='question';
    w.innerHTML=`<div class="qtitle">Q${q._no}. ${q['題目']}</div>
      <div class="radio"><label><input type="radio" name="q_${idx}" value="對"> 對</label>
      <label><input type="radio" name="q_${idx}" value="錯"> 錯</label></div>`;
    qList.appendChild(w);});
  updateProgress();
}
function updateProgress(){ const total=paper.length, answered=Object.keys(answers).length, rate=total?Math.round(answered/total*100):0; progBar.style.width=rate+'%'; btnSubmit.disabled=answered<total; }
qList.addEventListener('change',e=>{const t=e.target; if(t&&t.name&&t.value){answers[t.name]=t.value; updateProgress();}});

btnStart.addEventListener('click',()=>{
  const cats=['A','B','C','D','E','F'].filter(k=>String(currentPerson?.[k]||'')==='Y');
  const count=parseInt(selCount.value,10)||10;
  paper=buildPaper(cats,count);
  kvName.textContent=currentPerson.name; kvCount.textContent=String(paper.length);
  renderExam(); startCard.classList.add('hidden'); resultCard.classList.add('hidden'); examCard.classList.remove('hidden'); toast('題目已載入，請開始作答');
});

/* ===== 評分 & 上傳 ===== */
const scScore=$('#scScore'), scRate=$('#scRate'), scPass=$('#scPass'), wrongBox=document.getElementById('wrongBox');

function nowTWString(){ return new Date().toLocaleString('zh-TW',{timeZone:'Asia/Taipei',hour12:true}); }
async function uploadGET(params){
  const qs=new URLSearchParams(params); qs.set('action','write'); qs.set('_t',Date.now());
  const url=GAS_ENDPOINT+'?'+qs.toString();
  try{ const r=await fetch(url,{method:'GET',cache:'no-store'}); await r.text(); return true; }catch(e){ console.error(e); return false; }
}

btnSubmit.addEventListener('click', async ()=>{
  const total=paper.length; let correct=0, wrongs=[];
  paper.forEach((q,idx)=>{const a=answers['q_'+idx]; const ok=String(a)===String(q['答案']); if(ok)correct++; else wrongs.push({no:q._no,title:q['題目'],your:a,ans:q['答案']});});
  const score=correct, rate=Math.round(correct/total*100), pass=rate>=PASS_THRESHOLD?'通過':'未通過';
  scScore.textContent=`${score}/${total}`; scRate.textContent=`${rate}%`; scPass.textContent=pass;
  wrongBox.innerHTML = wrongs.length ? `<div class="hr"></div>
    <div class="kv" style="margin-bottom:6px">錯題明細（${wrongs.length}）</div>
    <table class="table"><thead><tr><th>#</th><th>題目</th><th>你的答案</th><th>正確答案</th></tr></thead>
    <tbody>${wrongs.map(w=>`<tr><td>${w.no}</td><td>${w.title}</td><td>${w.your||'-'}</td><td>${w.ans}</td></tr>`).join('')}</tbody></table>`
    : `<div class="hr"></div><div class="kv">完美！全部答對 ✅</div>`;
  examCard.classList.add('hidden'); resultCard.classList.remove('hidden');

  // 這裡送出「時間戳記(台北) + UA」給 GAS；NO 由 GAS 自增
  const cats=['A','B','C','D','E','F'].filter(k=>String(currentPerson?.[k]||'')==='Y').join(',');
  const payload={
    ts:new Date().toISOString(),       // ISO
    tsTW: nowTWString(),               // 你要的「2025/11/4 上午 11:16:06」格式
    name: currentPerson?.name||'',
    total, score, pass, rate, cats,
    ua: navigator.userAgent||''
  };
  const ok=await uploadGET(payload);
  toast(ok?'成績已上傳':'已送出（上傳未確認）');
});
</script>
</body>
</html>
